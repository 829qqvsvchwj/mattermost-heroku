#!/bin/bash

set -e

BUILDPACK=$(cd $(dirname $0); cd ..; pwd)

STEPTXT="----->"

step() {
    echo "$STEPTXT $@"
}

source $BUILDPACK/lib/deps.sh

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
RUBY_CACHE_DIR=$CACHE_DIR/ruby
RUBY_GEM_DIR=$BUILD_DIR/.heroku/ruby
GEM_PATH=$RUBY_GEM_DIR
PLATFORM=$(get_platform)
OS=$(get_os)
CPU=$(get_cpu)
NODE_BUILD_DIR=$BUILD_DIR/.heroku/node/
NODE_VERSION="v5.5.0"
NODE_DOWNLOAD_URL="http://s3pository.heroku.com/node/$NODE_VERSION/node-$NODE_VERSION-$OS-$CPU.tar.gz"
MATTERMOST_REPO="$(cat $ENV_DIR/MATTERMOST_REPO)"
MATTERMOST_BRANCH="$(cat $ENV_DIR/MATTERMOST_BRANCH)"
PATH="$RUBY_GEM_DIR/bin:$BUILDPACK/$PLATFORM/bin:$BUILD_DIR/.heroku/node/bin":$PATH

mkdir -p "$BUILD_DIR" "$CACHE_DIR"
mkdir -p $NODE_BUILD_DIR
mkdir -p $RUBY_CACHE_DIR
mkdir -p $RUBY_GEM_DIR
mkdir -p $BUILD_DIR/bin

step "Checking out $MATTERMOST_REPO#$MATTERMOST_BRANCH"
cd $BUILD_DIR
git clone --depth 1 -b $MATTERMOST_BRANCH $MATTERMOST_REPO platform
# cp -R platform/* .
# rm -r platform

IMPORTPATH=$(<$BUILD_DIR/platform/Godeps/Godeps.json jq -r .ImportPath)
GOVERSION=$(<$BUILD_DIR/platform/Godeps/Godeps.json jq -r .GoVersion)
GOFILENAME=${GOFILE:-$GOVERSION.$(uname|tr A-Z a-z)-amd64$(platext $GOVERSION).tar.gz}
GODOWNLOADURL=${GOURL:-$(urlfor $GOVERSION $GOFILENAME)}

step "Downloading and installing node $NODE_VERSION"
install_nodejs

step "Installing compass gem"
install_compass

step "Installing Go"
install_go $GOVERSION $CACHE_DIR

export GOBIN=$BUILD_DIR/bin
export GOROOT=$CACHE_DIR/$GOVERSION/go
export GOPATH=$BUILD_DIR/.heroku/go
export PATH=$GOROOT/bin:$PATH
mkdir -p $GOPATH/bin

cp $(which godep) $GOPATH/bin/

step "Building Mattermost"
MATTERMOSTPATH=$GOPATH/src/$IMPORTPATH
mkdir -p $MATTERMOSTPATH
cp -R $BUILD_DIR/platform/. $MATTERMOSTPATH
rm -rf $BUILD_DIR/platform

cd $MATTERMOSTPATH
make build-server
make build-client

sed -i'.bak' 's|react-0.14.3.js|react-0.14.3.min.js|g' $MATTERMOSTPATH/web/templates/head.html
sed -i'.bak' 's|react-dom-0.14.3.js|react-dom-0.14.3.min.js|g' $MATTERMOSTPATH/web/templates/head.html
sed -i'.bak' 's|jquery-2.1.4.js|jquery-2.1.4.min.js|g' $MATTERMOSTPATH/web/templates/head.html
sed -i'.bak' 's|bootstrap-3.3.5.js|bootstrap-3.3.5.min.js|g' $MATTERMOSTPATH/web/templates/head.html
sed -i'.bak' 's|react-bootstrap-0.28.1.js|react-bootstrap-0.28.1.min.js|g' $MATTERMOSTPATH/web/templates/head.html
sed -i'.bak' 's|perfect-scrollbar-0.6.7.jquery.js|perfect-scrollbar-0.6.7.jquery.min.js|g' $MATTERMOSTPATH/web/templates/head.html
sed -i'.bak' 's|bundle.js|bundle.min.js|g' $MATTERMOSTPATH/web/templates/head.html

mkdir data/
